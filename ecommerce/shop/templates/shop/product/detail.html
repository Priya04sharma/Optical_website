{% extends 'shop/base.html' %}
{% load static %}

{% block title %}
    {{ product.name }}
{% endblock %}

{% block content %}
<div class="container mt-5">
    

    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-2 rounded">
            <li class="breadcrumb-item"><a href="{% url 'shop:product_list' %}">Home</a></li>
            {% if product.category %}
                <li class="breadcrumb-item"><a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- Product Section -->
    <div class="row g-4 align-items-start">

        <!-- Product Image with Zoom -->
        <div class="col-md-5">
            <div class="product-card p-3 bg-white border shadow-sm text-center position-relative overflow-hidden">
                <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}"
                     alt="{{ product.name }}"
                     class="product-image w-100 zoom-image"
                     style="max-height: 350px; object-fit: contain;">
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-7">
            <h2>{{ product.name }}</h2>
            <h6 class="mb-3">
                <a href="{{ product.category.get_absolute_url }}" class="text-decoration-none text-muted">
                    {{ product.category }}
                </a>
            </h6>

           <!-- Dynamic Star Rating -->
<div class="mb-2">
    {% with avg_rating=avg|floatformat:0 %}
        {% for i in "12345" %}
            {% if forloop.counter <= avg_rating %}
                <i class="fas fa-star text-warning"></i>
            {% else %}
                <i class="far fa-star text-warning"></i>
            {% endif %}
        {% endfor %}
        <small class="text-muted">({{ review_count }} reviews)</small>
    {% endwith %}
</div>


            <!-- Stock -->
            {% if product.stock > 0 %}
                <span class="badge bg-success mb-2">In Stock</span>
            {% else %}
                <span class="badge bg-danger mb-2">Out of Stock</span>
            {% endif %}

            <!-- Price -->
            <p class="product-price h5">Rs. {{ product.price }}</p>

            <!-- Add to Cart -->
            {% if user.is_authenticated %}
                <form action="{% url 'cart_add' product.id %}" method="post" class="mb-3">
                    {% csrf_token %}
                    {{ cart_product_form }}
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-cart-plus me-1"></i> Add to Cart
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-warning">
                    Login to Add to Cart
                </a>
            {% endif %}

            <!-- Wishlist & Share -->
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-dark btn-sm"><i class="fas fa-heart"></i> Wishlist</button>
                <button class="btn btn-outline-dark btn-sm"><i class="fas fa-share-alt"></i> Share</button>
            </div>

            <!-- Description -->
            <hr>
            <h5>Description</h5>
            <p class="mt-2">{{ product.description|safe|linebreaksbr }}</p>
        </div>
    </div>

    <!-- Related Products from Same Category -->
    {% if related_products %}
    <div class="mt-5">
        <h4>Related Products</h4>
        <div class="row">
            {% for item in related_products %}
                {% if item.id != product.id and item.category == product.category %}
                <div class="col-md-3 mb-4">
                    <div class="product-card bg-white border h-100 shadow-sm">
                        <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}"
                             class="product-image w-100 p-2"
                             style="height: 200px; object-fit: contain;"
                             alt="{{ item.name }}">
                        <div class="p-3">
                            <a href="{{ item.get_absolute_url }}" class="product-title d-block mb-1 text-dark fw-semibold">
                                {{ item.name|truncatechars:40 }}
                            </a>
                            <div class="product-price mb-2 text-muted">Rs. {{ item.price }}</div>
                            <a href="{{ item.get_absolute_url }}" class="btn btn-sm btn-outline-primary w-100">View</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<!-- Image Zoom Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const img = document.querySelector('.zoom-image');
        img.addEventListener('mousemove', function (e) {
            const bounds = img.getBoundingClientRect();
            const x = ((e.pageX - bounds.left) / bounds.width) * 100;
            const y = ((e.pageY - bounds.top) / bounds.height) * 100;
            img.style.transformOrigin = `${x}% ${y}%`;
            img.style.transform = 'scale(2)';
        });
        img.addEventListener('mouseleave', function () {
            img.style.transform = 'scale(1)';
            img.style.transformOrigin = 'center';
        });
    });
</script>

<style>
    .zoom-image {
        transition: transform 0.3s ease;
        cursor: zoom-in;
    }
    .product-card {
        border-radius: 10px;
    }
    .product-title {
        font-size: 1rem;
    }
    .product-price {
        font-weight: bold;
    }
</style>
{% endblock %}
